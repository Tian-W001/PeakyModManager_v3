name: Process Avatar Images

on:
  push:
    paths:
      - "src/renderer/src/assets/avatars/character_avatars/**"

jobs:
  process-images:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download texconv
        run: |
          Invoke-WebRequest -Uri "https://github.com/microsoft/DirectXTex/releases/download/oct2025/texconv.exe" -OutFile "texconv.exe"
        shell: powershell

      - name: Convert, Rotate, and Rename Images
        run: |
          $targetDir = "src/renderer/src/assets/avatars/character_avatars"

          if (-not (Test-Path $targetDir)) {
            Write-Host "Directory $targetDir does not exist."
            exit 0
          }

          # Find all matching dds files
          $files = Get-ChildItem -Path $targetDir -Filter "*.dds"

          if ($files.Count -eq 0) {
            Write-Host "No matching .dds files found to process."
            exit 0
          }

          foreach ($file in $files) {
            Write-Host "Processing $($file.Name)..."

            # Convert to PNG and Rotate 180
            # -ft png: File Type PNG
            # -rotate 180: Rotate 180 degrees
            # -y: Overwrite existing
            # -o: Output directory
            $args = @("-ft", "png", "-rotate", "180", "-y", "-o", $targetDir, $file.FullName)
            $proc = Start-Process -FilePath ".\texconv.exe" -ArgumentList $args -PassThru -Wait

            if ($proc.ExitCode -eq 0) {
              $baseName = $file.BaseName
              $pngName = "$baseName.png"
              $pngPath = Join-Path $targetDir $pngName

              if (Test-Path $pngPath) {
                $finalNameStr = $baseName

                # Remove _r suffix if present
                if ($baseName -match "^(.*)_r$") {
                  $finalNameStr = $matches[1]
                }

                # Capitalize first letter
                if ($finalNameStr.Length -gt 0) {
                  $firstChar = $finalNameStr.Substring(0,1).ToUpper()
                  $rest = $finalNameStr.Substring(1)
                  $finalNameStr = "$firstChar$rest"
                }

                $finalPngName = "$finalNameStr.png"
                $finalPath = Join-Path $targetDir $finalPngName

                # Rename if the name changed (e.g. capitalization or _r removal)
                if ($pngName -cne $finalPngName) {
                    Move-Item -Path $pngPath -Destination $finalPath -Force
                    Write-Host "Renamed $pngName to $finalPngName"
                } else {
                    Write-Host "Generated $finalPngName"
                }

                # Remove original DDS file
                Remove-Item -Path $file.FullName -Force
                Write-Host "Removed original DDS file"
              }
            } else {
              Write-Error "Failed to convert $($file.Name)"
            }
          }
        shell: powershell

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add src/renderer/src/assets/avatars/character_avatars/*.png
          git add src/renderer/src/assets/avatars/character_avatars/*.dds
          # Check if there are changes to commit
          git diff --staged --quiet || git commit -m "Auto-convert avatar DDS to PNG"
          git push
